<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GR PROGRAM PRO 3.0</title>

  <style>
    :root {
      --bg-page: #f5f6fa;
      --bg-panel: #ffffff;
      --bg-soft: #f9fafc;
      --gold: #d9a643;
      --gold-soft: #f7d98a;
      --gold-light: #fff3c7;
      --border-soft: #e0e3ec;
      --border-strong: #c5c9d6;
      --text-main: #22252f;
      --text-sub: #6c7284;
      --text-gray: #9aa0b3;
      --danger: #ff5f6c;
      --radius-lg: 20px;
      --radius-md: 14px;
      --shadow-soft: 0 10px 30px rgba(9, 9, 30, 0.10);
      --transition-fast: 0.18s ease-out;
      --ripple-x: 50%;
      --ripple-y: 50%;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #ffffff 0, #f6f7fb 45%, #e4e9f7 100%);
      color: var(--text-main);
      overflow-x: hidden;
    }

    /* 背景特效 */
    .bg-rays { position: fixed; inset: 0; pointer-events: none; background: repeating-linear-gradient(135deg, rgba(180, 187, 207, 0.35) 0, rgba(180, 187, 207, 0.35) 1px, transparent 3px, transparent 10px); opacity: 0.06; z-index: 0; }
    .bg-glow { position: fixed; inset: -30%; pointer-events: none; background: radial-gradient(circle at 10% 0%, rgba(247, 217, 138, 0.55), transparent 60%), radial-gradient(circle at 85% 15%, rgba(255, 255, 255, 0.95), transparent 55%), radial-gradient(circle at 90% 100%, rgba(197, 208, 240, 0.55), transparent 55%); mix-blend-mode: screen; animation: glowMove 18s ease-in-out infinite alternate; z-index: 0; }
    @keyframes glowMove { 0% { transform: translate3d(-4%, 0, 0) scale(1); } 50% { transform: translate3d(4%, -2%, 0) scale(1.03); } 100% { transform: translate3d(-2%, 2%, 0) scale(1.01); } }
    .bg-stars { position: fixed; inset: 0; pointer-events: none; background: radial-gradient(rgba(247, 217, 138, 0.95) 0.9px, transparent 0.9px) 0 0 / 3px 3px, radial-gradient(rgba(255, 243, 199, 0.95) 1.1px, transparent 1.1px) 40px 60px / 4px 4px, transparent; opacity: 0.36; mix-blend-mode: soft-light; z-index: 0; animation: starsDrift 40s linear infinite alternate; }
    @keyframes starsDrift { 0% { transform: translate3d(0, 0, 0); } 50% { transform: translate3d(-25px, 15px, 0); } 100% { transform: translate3d(20px, -10px, 0); } }
    
    /* 流星 */
    .bg-meteors { position: fixed; inset: -10%; pointer-events: none; z-index: 1; overflow: hidden; }
    .meteor-trail { position: absolute; left: 0; top: 0; width: 260px; height: 3px; background: linear-gradient(90deg, rgba(247, 217, 138, 0), rgba(247, 217, 138, 1), rgba(247, 217, 138, 0)); opacity: 0; border-radius: 999px; filter: drop-shadow(0 0 10px rgba(247, 217, 138, 0.9)); transform-origin: left center; animation-timing-function: linear; animation-iteration-count: infinite; }
    @keyframes meteorCurve1 { 0% { transform: translate3d(0, 0, 0) rotate(22deg); opacity: 0; } 10% { opacity: 1; } 45% { transform: translate3d(-260px, 120px, 0) rotate(26deg); opacity: 1; } 100% { transform: translate3d(-520px, 260px, 0) rotate(30deg); opacity: 0; } }
    @keyframes meteorCurve2 { 0% { transform: translate3d(0, 0, 0) rotate(30deg); opacity: 0; } 12% { opacity: 1; } 50% { transform: translate3d(-220px, 160px, 0) rotate(26deg); opacity: 1; } 100% { transform: translate3d(-480px, 320px, 0) rotate(22deg); opacity: 0; } }
    @keyframes meteorCurve3 { 0% { transform: translate3d(0, 0, 0) rotate(18deg); opacity: 0; } 8% { opacity: 1; } 40% { transform: translate3d(-200px, 90px, 0) rotate(24deg); opacity: 1; } 100% { transform: translate3d(-450px, 250px, 0) rotate(30deg); opacity: 0; } }
    .meteor-curve-1 { animation-name: meteorCurve1; } .meteor-curve-2 { animation-name: meteorCurve2; } .meteor-curve-3 { animation-name: meteorCurve3; }

    /* 漣漪 */
    .ripple-overlay { position: fixed; inset: 0; pointer-events: none; background: radial-gradient(circle at var(--ripple-x) var(--ripple-y), rgba(247, 217, 138, 0.7) 0%, rgba(247, 217, 138, 0.45) 13%, rgba(247, 217, 138, 0.18) 34%, transparent 72%); opacity: 0; transform: scale(0.7); z-index: 2; }
    .ripple-overlay.active { animation: ripple 0.9s ease-out forwards; }
    @keyframes ripple { 0% { opacity: 0.6; transform: scale(0.7); } 100% { opacity: 0; transform: scale(2.4); } }

    /* 主要容器 */
    .app { position: relative; z-index: 3; max-width: 1200px; margin: 0 auto; padding: 24px 16px 32px; }
    .screen { display: none; }
    .screen.active { display: block; }
    .center-layout { min-height: calc(100vh - 80px); display: flex; align-items: center; justify-content: center; }
    .panel { width: 100%; max-width: 520px; padding: 26px 22px 20px; border-radius: var(--radius-lg); background: var(--bg-panel); border: 1px solid var(--border-soft); box-shadow: var(--shadow-soft); }
    
    .title-lg { text-align: left; font-size: 22px; letter-spacing: 3px; font-weight: 700; margin-bottom: 4px; color: var(--gold); }
    .subtitle { text-align: left; font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-gray); margin-bottom: 22px; }
    label { display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-sub); }
    
    .input { width: 100%; padding: 10px 13px; border-radius: 999px; border: 1px solid var(--border-soft); background: #f9fafc; color: var(--text-main); font-size: 14px; margin-bottom: 12px; outline: none; transition: var(--transition-fast); }
    .input:focus { border-color: var(--gold); box-shadow: 0 0 0 1px rgba(217, 166, 67, 0.6); background: #ffffff; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 18px; border-radius: 999px; font-size: 13px; font-weight: 600; border: none; cursor: pointer; transition: var(--transition-fast); white-space: nowrap; }
    .btn-primary { width: 100%; background: linear-gradient(120deg, #ffe9b6, #f0c56a); color: #5b3a04; box-shadow: 0 10px 20px rgba(209, 167, 72, 0.4); margin-top: 4px; }
    .btn-primary:hover { filter: brightness(1.05); transform: translateY(-1px); box-shadow: 0 13px 28px rgba(209, 167, 72, 0.55); }
    .btn-outline { width: 100%; margin-top: 8px; background: #ffffff; border: 1px solid var(--border-soft); color: var(--text-sub); }
    .btn-outline:hover { background: #f5f6fa; }
    .btn-danger { background: #ff6f7f; color: #ffffff; box-shadow: 0 8px 18px rgba(255, 111, 127, 0.4); }
    
    .error-box { margin-top: 10px; padding: 8px 11px; border-radius: var(--radius-md); background: #ffe8ea; border: 1px solid #ffadb5; color: #bc2033; font-size: 12px; text-align: center; }

    /* 後台樣式 */
    .admin-panel { margin-top: 16px; padding-top: 10px; border-top: 1px dashed var(--border-soft); display: none; }
    .admin-panel.active { display: block; }
    .admin-title { font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
    .admin-input-row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
    .admin-input-row .input { margin-bottom: 0; flex: 1 1 150px; }
    .btn-sm { padding: 5px 10px; font-size: 11px; border-radius: 6px; }

    /* 新增：後台表格與狀態標籤 */
    .code-table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 11px; color: var(--text-sub); }
    .code-table th { padding: 8px 4px; border-bottom: 2px solid #edf0f5; text-align: left; font-weight: 600; color: var(--text-main); }
    .code-table td { padding: 8px 4px; border-bottom: 1px solid #edf0f5; text-align: left; vertical-align: middle; }
    
    .badge { padding: 3px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; color: white; display: inline-block; }
    .badge-gray { background-color: #b0b3b8; }   /* 未使用 */
    .badge-green { background-color: #2ecc71; }  /* 使用中 */
    .badge-red { background-color: #e74c3c; }    /* 已停用 */
    
    .btn-group { display: flex; gap: 4px; }

    .badge-empty { font-size: 11px; color: var(--text-gray); margin-top: 4px; }

    /* 遊戲與機台列表 CSS */
    .game-panel { max-width: 720px; padding: 20px 18px 18px; border-radius: var(--radius-lg); border: 1px solid var(--border-soft); background: var(--bg-panel); box-shadow: var(--shadow-soft); margin: 0 auto; }
    .title-md { text-align: left; font-size: 20px; letter-spacing: 2px; margin-bottom: 12px; color: var(--gold); }
    .game-list { display: flex; flex-wrap: wrap; gap: 10px; }
    .game-card { flex: 1 1 48%; border-radius: 18px; border: 1px solid var(--border-soft); background: linear-gradient(135deg, #ffffff, #f8fafc); padding: 14px 13px; cursor: pointer; transition: var(--transition-fast); box-shadow: 0 6px 12px rgba(26, 26, 66, 0.06); }
    .game-card:hover { box-shadow: 0 9px 18px rgba(26, 26, 66, 0.12); transform: translateY(-1px); }
    .game-card.active { border-color: var(--gold); box-shadow: 0 0 0 1px rgba(217, 166, 67, 0.8), 0 10px 22px rgba(217, 166, 67, 0.35); }
    .game-name { font-size: 15px; font-weight: 600; color: var(--text-main); }
    .note-box { margin-top: 14px; padding: 9px 11px; border-radius: 14px; border: 1px solid var(--border-soft); background: var(--bg-soft); font-size: 12px; color: var(--text-sub); }
    .confirm-game-btn { margin-top: 16px; }

    .page-header { margin-bottom: 14px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .title-page { font-size: 20px; letter-spacing: 3px; font-weight: 700; color: var(--gold); }
    .chip-row { display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 6px; }
    .chip { padding: 4px 10px; border-radius: 999px; background: #ffffff; border: 1px solid var(--border-soft); font-size: 11px; color: var(--text-sub); box-shadow: 0 4px 8px rgba(26, 26, 66, 0.06); }
    .top-actions { margin: 10px auto 16px; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
    .select-wrap { position: relative; min-width: 160px; }
    .select { appearance: none; width: 100%; padding: 8px 30px 8px 12px; border-radius: 999px; border: 1px solid var(--border-soft); background: #ffffff; color: var(--text-main); font-size: 13px; cursor: pointer; box-shadow: 0 4px 10px rgba(26, 26, 66, 0.06); }
    .select-arrow { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; font-size: 10px; color: var(--text-gray); }

    .machine-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap: 10px; }
    .machine-card { position: relative; border-radius: 16px; padding: 10px 12px; background: #ffffff; border: 1px solid var(--border-soft); color: var(--text-main); box-shadow: 0 7px 16px rgba(26, 26, 66, 0.08); transition: var(--transition-fast); cursor: pointer; }
    .machine-card:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(26, 26, 66, 0.12); }
    .machine-card.selected { outline: 2px solid rgba(217, 166, 67, 0.7); outline-offset: 2px; }
    .machine-id { font-size: 14px; font-weight: 600; margin-bottom: 3px; }
    .machine-rate { font-size: 12px; color: var(--text-sub); }
    .machine-rate-extra { font-size: 11px; color: var(--text-sub); margin-top: 1px; }
    .machine-card.high-rate { border-color: var(--gold); box-shadow: 0 0 0 1px rgba(217, 166, 67, 0.8), 0 12px 24px rgba(217, 166, 67, 0.35); }
    .top-badge { position: absolute; top: -8px; right: 10px; padding: 3px 9px; border-radius: 999px; font-size: 10px; letter-spacing: 1px; background: linear-gradient(135deg, #ffeec5, #f5c86f); color: #5c3b0a; box-shadow: 0 4px 10px rgba(214, 164, 73, 0.6); }
    .top-badge.top-2 { background: linear-gradient(135deg, #f3f7ff, #cfd8f0); color: #364063; }
    .top-badge.top-3 { background: linear-gradient(135deg, #ffecd6, #f3b984); color: #5a3212; }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: radial-gradient(circle at top, rgba(255, 255, 255, 0.95), rgba(215, 222, 238, 0.96)); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 25; }
    .modal-overlay.active { display: flex; }
    .signal-modal { width: min(640px, 92vw); border-radius: 22px; background: #ffffff; border: 1px solid var(--border-soft); box-shadow: 0 16px 40px rgba(26, 26, 66, 0.25); padding: 18px 18px 16px; position: relative; animation: modalIn 0.22s ease-out; color: var(--text-main); }
    @keyframes modalIn { 0% { opacity: 0; transform: translateY(8px) scale(0.97); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
    .signal-header { display: flex; justify-content: center; align-items: center; margin-bottom: 12px; position: relative; }
    .signal-title { font-size: 20px; letter-spacing: 3px; font-weight: 700; color: var(--gold); text-align: center; }
    .signal-close { position: absolute; right: 0; top: 0; width: 26px; height: 26px; border-radius: 999px; border: 1px solid var(--border-soft); background: #f5f6fa; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; color: var(--text-gray); }
    .signal-list { margin: 4px 0 12px; display: flex; flex-direction: column; gap: 8px; }
    .signal-item { display: flex; align-items: center; padding: 9px 11px; border-radius: 16px; background: linear-gradient(135deg, #ffffff, #f7f8fd); border: 1px solid var(--border-soft); box-shadow: 0 6px 14px rgba(26, 26, 66, 0.08); opacity: 0; transform: translateY(5px); animation: itemIn 0.3s ease-out forwards; animation-delay: var(--delay, 0ms); }
    @keyframes itemIn { 0% { opacity: 0; transform: translateY(5px); } 100% { opacity: 1; transform: translateY(0); } }
    .signal-icon-wrapper { width: 44px; height: 44px; border-radius: 16px; background: #ffffff; border: 1px solid var(--border-soft); display: flex; align-items: center; justify-content: center; margin-right: 10px; flex-shrink: 0; box-shadow: 0 6px 12px rgba(26, 26, 66, 0.12); }
    .signal-icon-img { width: 32px; height: 32px; object-fit: contain; display: block; }
    .signal-text { flex: 1; display: flex; flex-direction: column; gap: 2px; }
    .signal-name { font-size: 14px; font-weight: 600; }
    .signal-sub { font-size: 11px; color: var(--text-sub); }
    .signal-qty { border-radius: 999px; padding: 6px 12px; background: linear-gradient(135deg, #fff0c5, #f2c873); color: #5b3907; font-size: 13px; font-weight: 700; box-shadow: 0 6px 14px rgba(217, 166, 67, 0.4); }
    .signal-footer { margin-top: 2px; }
    .signal-tip { padding: 8px 11px; border-radius: 14px; border: 1px solid var(--border-soft); background: #f9fafc; font-size: 12px; color: var(--text-sub); margin-bottom: 10px; }
    .signal-tip b { color: var(--gold); }
    .signal-confirm { width: 100%; border-radius: 999px; border: none; padding: 10px 16px; font-size: 13px; font-weight: 600; background: linear-gradient(120deg, #ffe9b6, #f0c56a); color: #5b3a04; cursor: pointer; box-shadow: 0 10px 22px rgba(209, 167, 72, 0.4); transition: var(--transition-fast); }
    .signal-confirm:hover { filter: brightness(1.05); transform: translateY(-1px); }

    .loading-overlay { position: fixed; inset: 0; background: radial-gradient(circle at center, rgba(255, 255, 255, 0.96), rgba(228, 233, 245, 0.96)); display: none; align-items: center; justify-content: center; z-index: 20; }
    .loading-overlay.active { display: flex; }
    .loader { display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .spinner { width: 32px; height: 32px; border-radius: 50%; border: 3px solid rgba(198, 204, 221, 0.4); border-top-color: var(--gold); animation: spin 0.8s linear infinite; }
    .loader-text { font-size: 12px; color: var(--text-sub); }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .app { padding: 18px 12px 28px; }
      .panel, .game-panel { padding: 20px 16px 14px; }
      .page-header { flex-direction: column; align-items: flex-start; }
      .chip-row { justify-content: flex-start; }
      .machine-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="bg-rays"></div><div class="bg-stars"></div><div class="bg-glow"></div>
  <div class="bg-meteors" id="bgMeteors"></div><div class="ripple-overlay" id="rippleOverlay"></div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loader"><div class="spinner"></div><div class="loader-text">系統分析中，請稍候…</div></div>
  </div>

  <div class="modal-overlay" id="signalModal">
    <div class="signal-modal">
      <div class="signal-header">
        <div class="signal-title" id="signalTitle">第 0000 房購買訊號</div>
        <button class="signal-close" id="signalClose">✕</button>
      </div>
      <div class="signal-list" id="signalItemList"></div>
      <div class="signal-footer">
        <div class="signal-tip"><b>系統提示：</b>此購買訊號為 AI 智能生成，建議參考爆分率 <b id="signalRateText">75%</b> 進行分析。</div>
        <button class="signal-confirm" id="signalConfirm">確認</button>
      </div>
    </div>
  </div>

  <div class="app">
    <div class="screen active" id="screenLogin">
      <div class="center-layout">
        <div class="panel">
          <div class="title-lg">PROGRAM PRO 3.0</div>
          <div class="subtitle">AUTHENTICATION · ACCESS CONTROL</div>
          <label>系統授權碼</label>
          <input id="licenseInput" class="input" placeholder="請輸入授權碼" />
          <label>平台帳號</label>
          <input id="accountInput" class="input" placeholder="請輸入遊戲帳號" />
          <label>進場金額</label>
          <input id="amountInput" class="input" type="number" min="0" placeholder="請輸入進場金額" />
          <button class="btn btn-primary" id="btnVerify">驗證並進入系統</button>
          <button class="btn btn-outline" id="btnToggleAdmin">管理授權碼</button>
          <div class="error-box" id="loginError" style="display:none;"></div>

          <div class="admin-panel" id="adminPanel">
            <div class="admin-title">授權碼管理後台</div>
            <div class="admin-input-row">
              <input id="adminCodeInput" class="input" placeholder="授權碼，例如 GC-2025-001" />
              <input id="adminExpireInput" class="input" type="date" />
              <button class="btn btn-primary btn-sm" id="btnAddCode">新增授權碼</button>
            </div>
            <table class="code-table">
              <thead><tr><th style="width:30%">授權碼</th><th style="width:25%">到期日</th><th style="width:15%">狀態</th><th>操作</th></tr></thead>
              <tbody id="codeTableBody"></tbody>
            </table>
            <div class="badge-empty" id="emptyCodesHint">無資料</div>
          </div>
        </div>
      </div>
    </div>

    <div class="screen" id="screenGame">
      <div class="center-layout">
        <div class="game-panel">
          <div class="title-md">選擇遊戲模組</div>
          <div class="game-list">
            <div class="game-card" data-id="ATG1"><div class="game-name">ATG-戰神賽特</div></div>
            <div class="game-card" data-id="ATG2"><div class="game-name">ATG-戰神賽特2覺醒之力</div></div>
          </div>
          <div class="note-box">選定遊戲後會自動獲取遊戲數據並提供分析，隨時可用「切換遊戲」重新選擇遊戲。</div>
          <button class="btn btn-primary confirm-game-btn" id="btnGameConfirm" disabled>開始分析</button>
        </div>
      </div>
    </div>

    <div class="screen" id="screenDashboard">
      <div class="page-header">
        <div class="title-page" id="titlePage">GR專用戰神賽特</div>
        <div class="chip-row">
          <div class="chip" id="chipAccount">帳號：-</div>
          <div class="chip" id="chipAmount">金額：-</div>
          <div class="chip" id="chipGame">當前遊戲：-</div>
        </div>
      </div>
      <div class="top-actions">
        <button class="btn btn-primary" id="btnRefresh">點此更新數據</button>
        <div class="select-wrap">
          <select class="select" id="gameSelect">
            <option value="">切換遊戲</option>
            <option value="ATG1">ATG-戰神賽特</option>
            <option value="ATG2">ATG-戰神賽特2覺醒之力</option>
          </select>
          <span class="select-arrow">▼</span>
        </div>
        <button class="btn btn-danger" id="btnLogout">登出系統</button>
      </div>
      <div class="machine-grid" id="machineGrid"></div>
    </div>
  </div>

  <script>
    // 1. 初始化工具函數與 Firebase
    function showLoading(ms = 500) { return new Promise(r => setTimeout(r, ms)); }
    
    function showScreen(name) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      const target = document.getElementById(name === "login" ? "screenLogin" : name === "game" ? "screenGame" : "screenDashboard");
      if (target) target.classList.add("active");
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDNs7BP2h51PzsJZ9Lro0Ev1nzyqZM-1Qs",
      authDomain: "gg-pro-3.firebaseapp.com",
      projectId: "gg-pro-3",
      storageBucket: "gg-pro-3.firebasestorage.app",
      messagingSenderId: "460046000234",
      appId: "1:460046000234:web:e1c72ba1758376ce582a13"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ADMIN_PASSWORD = "aa888";
    const MACHINE_COUNT = 60;
    const GAME_CONFIG = {
      ATG1: { name: "ATG-戰神賽特", title: "GR專用戰神賽特", maxMachine: 3000 },
      ATG2: { name: "ATG-戰神賽特2覺醒之力", title: "GR專用戰神賽特2", maxMachine: 3000 }
    };

    let currentEditingId = null;
    let currentUserDocId = null; // ⭐ 全域變數：紀錄目前登入的 ID

    // 2. 登入邏輯 (紀錄使用者 ID，以利登出時修改狀態)
    function getTodayDate() { const now = new Date(); now.setHours(0,0,0,0); return now; }

    async function isLicenseValid(code) {
      try {
        const snapshot = await db.collection("licenses").where("code", "==", code).get();
        if (snapshot.empty) return { valid: false, msg: "授權碼不存在" };

        const today = getTodayDate();
        for (const doc of snapshot.docs) {
          const data = doc.data();
          
          if (data.status === "disabled") return { valid: false, msg: "此授權碼已被管理員停用" };

          let expireStr = (data.expire || "").trim().replace(/\//g, '-');
          if (expireStr) {
            if (new Date(expireStr) < today) {
              await db.collection("licenses").doc(doc.id).delete();
              return { valid: false, msg: "授權碼已過期並自動刪除" };
            }
          }

          // ⭐ 登入成功：更新狀態為 used，並紀錄 docId
          currentUserDocId = doc.id;
          if (data.status !== "used") {
            await db.collection("licenses").doc(doc.id).update({ status: "used" });
          }
          return { valid: true };
        }
      } catch (e) { console.error(e); return { valid: false, msg: "系統錯誤" }; }
    }

    document.getElementById("btnVerify").onclick = async () => {
      const code = document.getElementById("licenseInput").value.trim();
      const errBox = document.getElementById("loginError");
      if (!code) { errBox.innerText = "請輸入授權碼"; errBox.style.display = "block"; return; }
      
      const res = await isLicenseValid(code);
      if (!res.valid) {
        errBox.innerText = res.msg; errBox.style.display = "block"; return;
      }

      localStorage.setItem("ofa_account", document.getElementById("accountInput").value.trim() || "未設定");
      localStorage.setItem("ofa_amount", document.getElementById("amountInput").value.trim() || "-");
      errBox.style.display = "none";
      await showLoading();
      showScreen("game");
    };

    // ⭐ 登出邏輯修正：登出時改回 unused
    document.getElementById("btnLogout").onclick = async () => {
      if (currentUserDocId) {
        // 嘗試將狀態改回 unused
        db.collection("licenses").doc(currentUserDocId).update({ status: "unused" }).catch(e=>console.log(e));
        currentUserDocId = null;
      }
      showScreen("login");
    };

    // ⭐ 視窗關閉監聽 (嘗試在關閉分頁時釋放狀態)
    window.addEventListener("beforeunload", () => {
      if (currentUserDocId) {
         // 注意：這裡不一定保證每次關閉視窗都會成功送出，取決於瀏覽器速度
         db.collection("licenses").doc(currentUserDocId).update({ status: "unused" });
      }
    });

    // 3. 後台管理
    document.getElementById("btnToggleAdmin").onclick = () => {
      const p = document.getElementById("adminPanel");
      if (!p.classList.contains("active")) {
        if (prompt("請輸入管理者密碼：") !== ADMIN_PASSWORD) return alert("密碼錯誤");
      }
      p.classList.toggle("active");
      if (p.classList.contains("active")) renderCodeTable();
    };

    async function renderCodeTable() {
      const tbody = document.getElementById("codeTableBody");
      tbody.innerHTML = "";
      document.getElementById("emptyCodesHint").style.display = "none";
      const today = getTodayDate();

      try {
        const snap = await db.collection("licenses").orderBy("code").get();
        if (snap.empty) { document.getElementById("emptyCodesHint").style.display = "block"; return; }

        for (const doc of snap.docs) {
          const data = doc.data();
          
          let expireStr = (data.expire || "").trim().replace(/\//g, '-');
          if (expireStr && new Date(expireStr) < today) {
             await db.collection("licenses").doc(doc.id).delete();
             continue; 
          }

          let badge = '<span class="badge badge-gray">未使用</span>';
          if (data.status === "used") badge = '<span class="badge badge-green">使用中</span>';
          if (data.status === "disabled") badge = '<span class="badge badge-red">已停用</span>';

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${data.code}</td>
            <td>${data.expire || "永久"}</td>
            <td>${badge}</td>
            <td>
              <div class="btn-group">
                <button class="btn-sm" style="background:#3498db;color:#fff;border:none;cursor:pointer" onclick="editLicense('${doc.id}','${data.code}','${data.expire||''}')">編輯</button>
                <button class="btn-sm" style="background:#f39c12;color:#fff;border:none;cursor:pointer" onclick="toggleStatus('${doc.id}','${data.status}')">${data.status==='disabled'?'啟用':'停用'}</button>
                <button class="btn-sm" style="background:#ff5f6c;color:#fff;border:none;cursor:pointer" onclick="delLicense('${doc.id}','${data.code}')">刪除</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        }
      } catch (e) { console.error(e); }
    }

    window.editLicense = (id, code, expire) => {
      document.getElementById("adminCodeInput").value = code;
      document.getElementById("adminExpireInput").value = expire;
      currentEditingId = id;
      const btn = document.getElementById("btnAddCode");
      btn.textContent = "確認修改";
      btn.style.background = "#27ae60";
    };

    window.toggleStatus = async (id, currentStatus) => {
      const newStatus = (currentStatus === "disabled") ? "unused" : "disabled"; 
      await db.collection("licenses").doc(id).update({ status: newStatus });
      renderCodeTable();
    };

    window.delLicense = async (id, code) => {
      if (confirm(`刪除「${code}」？`)) {
        await db.collection("licenses").doc(id).delete();
        if (currentEditingId === id) resetAdminInput();
        renderCodeTable();
      }
    };

    function resetAdminInput() {
      document.getElementById("adminCodeInput").value = "";
      document.getElementById("adminExpireInput").value = "";
      currentEditingId = null;
      const btn = document.getElementById("btnAddCode");
      btn.textContent = "新增授權碼";
      btn.style.background = "";
    }

    document.getElementById("btnAddCode").onclick = async () => {
      const code = document.getElementById("adminCodeInput").value.trim();
      const expire = document.getElementById("adminExpireInput").value.trim();
      if (!code) return alert("請輸入代碼");

      try {
        if (currentEditingId) {
          await db.collection("licenses").doc(currentEditingId).update({ code, expire });
          alert("修改完成");
        } else {
          const dup = await db.collection("licenses").where("code", "==", code).get();
          if (!dup.empty) return alert("代碼已存在");
          await db.collection("licenses").add({ code, expire, status: "unused", created: new Date().toISOString() });
          alert("新增成功");
        }
        resetAdminInput();
        renderCodeTable();
      } catch (e) { console.error(e); alert("操作失敗"); }
    };

    // 4. 遊戲邏輯與其他
    let selectedGameId = null;
    const SIGNAL_ITEMS = [
      { id: "eye", name: "眼", sub: "高機率特殊圖示" }, { id: "snake", name: "蛇", sub: "多線連動時表現佳" },
      { id: "knife", name: "彎刀", sub: "高倍線型轉折關鍵" }, { id: "bow", name: "弓箭", sub: "搭配眼圖時爆分加成" },
      { id: "blue", name: "藍寶石", sub: "穩定線型補圖" }, { id: "green", name: "綠寶石", sub: "連線延伸機率提升" },
      { id: "purple", name: "紫寶石", sub: "高價值寶石組合" }, { id: "red", name: "紅寶石", sub: "中段爆擊觸發點" },
      { id: "yellow", name: "黃寶石", sub: "中高倍補圖" }, { id: "scatter", name: "SCATTER", sub: "高爆分關鍵觸發符號" }
    ];
    function getMaxQty(id) { return (["eye","snake","knife","bow"].includes(id))?5:(id==="scatter"?3:7); }
    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    document.querySelectorAll(".game-card").forEach(c => {
      c.onclick = () => {
        document.querySelectorAll(".game-card").forEach(x => x.classList.remove("active"));
        c.classList.add("active");
        selectedGameId = c.dataset.id;
        document.getElementById("btnGameConfirm").disabled = false;
      };
    });
    document.getElementById("btnGameConfirm").onclick = async () => {
      if(!selectedGameId) return;
      localStorage.setItem("ofa_selected_game", selectedGameId);
      await showLoading();
      initDashboard();
      showScreen("dashboard");
    };

    function initDashboard() {
      const cfg = GAME_CONFIG[selectedGameId] || GAME_CONFIG.ATG1;
      document.getElementById("titlePage").innerText = cfg.title;
      document.getElementById("chipAccount").innerText = "帳號：" + (localStorage.getItem("ofa_account")||"-");
      document.getElementById("chipAmount").innerText = "金額：" + (localStorage.getItem("ofa_amount")||"-");
      document.getElementById("chipGame").innerText = "當前遊戲：" + cfg.name;
      generateMachines(cfg);
    }

    function generateMachines(cfg) {
      const grid = document.getElementById("machineGrid");
      grid.innerHTML = "";
      const used = new Set();
      const list = [];
      while(list.length < MACHINE_COUNT) {
        const n = rand(1, 3000);
        if(used.has(n)) continue;
        used.add(n);
        list.push({ no:n, rate:rand(60,89), jp:rand(60,90), awaken:(cfg===GAME_CONFIG.ATG2?rand(30,90):null) });
      }
      list.sort((a,b)=>b.rate-a.rate);
      list.forEach((m, i) => {
        const d = document.createElement("div");
        d.className = "machine-card" + (m.rate>=80?" high-rate":"");
        if(i<3) d.innerHTML += `<div class="top-badge${i>0?' top-'+(i+1):''}">TOP ${i+1}</div>`;
        d.innerHTML += `<div class="machine-id">第 ${m.no} 台</div><div class="machine-rate">大獎爆分率 ${m.rate}%</div><div class="machine-rate-extra">JP彩池命中率 ${m.jp}%</div>`;
        if(m.awaken) d.innerHTML += `<div class="machine-rate-extra">覺醒機率 ${m.awaken}%</div>`;
        d.onmouseenter = e => {
           const r = document.getElementById("rippleOverlay");
           document.documentElement.style.setProperty("--ripple-x", e.clientX+"px");
           document.documentElement.style.setProperty("--ripple-y", e.clientY+"px");
           r.classList.remove("active"); void r.offsetWidth; r.classList.add("active");
        };
        d.onclick = () => openSignalModal(m.no, m.rate);
        grid.appendChild(d);
      });
    }

    function openSignalModal(no, rate) {
      document.getElementById("signalTitle").innerText = `第 ${no} 房購買訊號`;
      const list = document.getElementById("signalItemList"); list.innerHTML = "";
      const picks = [...SIGNAL_ITEMS].sort(()=>Math.random()-0.5).slice(0,3);
      picks.forEach((it, idx) => {
        const qty = rand(1, getMaxQty(it.id));
        const row = document.createElement("div"); row.className = "signal-item";
        row.style.setProperty("--delay", (idx*70)+"ms");
        const imgSrc = `images/${it.id}.png`;
        row.innerHTML = `<div class="signal-icon-wrapper"><img class="signal-icon-img" src="${imgSrc}" onerror="this.src='images/scatter.png'"></div>
          <div class="signal-text"><div class="signal-name">${it.name}</div><div class="signal-sub">${it.sub}</div></div>
          <div class="signal-qty">× ${qty}</div>`;
        list.appendChild(row);
      });
      document.getElementById("signalRateText").innerText = rate + "%";
      document.getElementById("signalModal").classList.add("active");
    }

    const closeModal = () => document.getElementById("signalModal").classList.remove("active");
    document.getElementById("signalClose").onclick = closeModal;
    document.getElementById("signalConfirm").onclick = closeModal;
    document.getElementById("signalModal").onclick = e => { if(e.target.id==="signalModal") closeModal(); };

    document.getElementById("btnRefresh").onclick = () => initDashboard();
    document.getElementById("gameSelect").onchange = async e => {
       if(!e.target.value) return;
       selectedGameId = e.target.value; localStorage.setItem("ofa_selected_game", selectedGameId);
       await showLoading(); initDashboard(); showScreen("dashboard"); e.target.value="";
    };

    function initMeteors() {
      const c = document.getElementById("bgMeteors");
      if(!c) return;
      for(let i=0; i<10; i++) {
        const d = document.createElement("div");
        d.className = `meteor-trail meteor-curve-${rand(1,3)}`;
        d.style.left = rand(-10,110)+"%"; d.style.top = rand(-20,40)+"%";
        d.style.animationDuration = rand(2,7)+"s"; d.style.animationDelay = rand(0,12)+"s";
        c.appendChild(d);
      }
    }
    document.addEventListener("DOMContentLoaded", initMeteors);
  </script>
</body>
</html>